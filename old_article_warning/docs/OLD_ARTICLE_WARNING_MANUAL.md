# 📝 Docbase古い記事への注意書き追加システム

## 🎯 概要

1年以上更新されていないDocbase記事に自動で注意書きを追加するシステムです。

**追加される注意書き:**
```
⚠️ **この記事は1年以上前に書かれたものです。情報が古い可能性があります。**

---
```

## 🛠️ 作成したスクリプト

### 1. メインスクリプト
- **`add_warning_to_old_articles.py`** - 一括処理用メインスクリプト

### 2. 補助スクリプト
- **`find_old_articles_extended.py`** - 古い記事の検索・分析
- **`test_old_articles.py`** - サンプル記事でのテスト
- **`add_old_article_warning.py`** - 個別記事処理用

## 🚀 使用方法

### 基本的な実行手順

```bash
# Docbaseディレクトリに移動
cd /Users/g.ohorudingusu/Docbase

# 仮想環境をアクティベート
source docbase_env/bin/activate

# 1. 確認のみ（推奨・最初に実行）
python add_warning_to_old_articles.py

# 2. テスト実行（5件のみ処理）
python add_warning_to_old_articles.py --test

# 3. 実際に更新実行
python add_warning_to_old_articles.py --execute
```

### ⚠️ 重要な注意事項

1. **必ず確認モードから実行**してください
2. **テストモード**で動作を確認してから本実行
3. **実行前にバックアップ**を推奨
4. **大量記事がある場合は時間がかかります**

## 📊 システムの動作

### 1. 記事の取得
- 全記事を段階的に取得（最大2500件）
- 50件ずつ効率的に処理
- API制限に配慮した待機時間

### 2. 古い記事の判定
- **基準**: 1年以上更新されていない記事
- `updated_at` または `created_at` で判定
- 公開範囲に関係なく処理

### 3. 注意書きの追加
- **重複チェック**: 既に注意書きがある場合はスキップ
- **記事の先頭**に注意書きを追加
- **元の内容は保持**

### 4. 処理結果の報告
- 処理件数の詳細レポート
- エラー記事の特定
- 実行時間の表示

## 🔍 現在の状況

### 最新の調査結果（2025年1月30日）
- **調査範囲**: 最新200件の記事
- **結果**: 1年以上古い記事は **0件**
- **状況**: 非常に活発に更新されているDocbase

### 推定される理由
1. 定期的なメンテナンス体制
2. 活発な記事更新活動
3. 比較的新しいDocbaseチーム

## 🎭 テスト・検証方法

### 手動での動作確認
```bash
# 古い記事の検索テスト
python find_old_articles_extended.py

# サンプル記事での動作テスト
python test_old_articles.py
```

### 結果ファイルの確認
- `old_articles_found.json` - 発見された古い記事のリスト
- 処理前に内容を確認可能

## 📅 定期実行の提案

### 推奨実行スケジュール
- **月次実行**: 毎月末に確認モードで実行
- **四半期実行**: 3ヶ月ごとに本実行
- **年次実行**: 年度末に全件チェック

### cronでの自動化例
```bash
# 毎月最終日の午前2時に確認モードで実行
0 2 28-31 * * [ "$(date +\%d -d tomorrow)" = "01" ] && cd /Users/g.ohorudingusu/Docbase && source docbase_env/bin/activate && python add_warning_to_old_articles.py > /tmp/docbase_old_check.log 2>&1
```

## 🔧 カスタマイズ

### 判定期間の変更
スクリプト内の `months_threshold=12` を変更：
- 6ヶ月: `months_threshold=6`
- 18ヶ月: `months_threshold=18`

### 注意書きテキストの変更
`WARNING_TEXT` 変数を編集：
```python
WARNING_TEXT = """🔔 **カスタム注意書き**

---

"""
```

### 処理対象の限定
- 特定の公開範囲のみ: `scope` でフィルタ
- 特定のタグのみ: `tags` でフィルタ

## 🚨 トラブルシューティング

### よくあるエラー

1. **APIトークンエラー**
   ```
   エラー: DOCBASE_ACCESS_TOKEN が設定されていません
   ```
   → `.env`ファイルの設定を確認

2. **レート制限エラー**
   ```
   429 Too Many Requests
   ```
   → 処理間隔を長くする（`time.sleep`を増加）

3. **タイムアウトエラー**
   → `max_pages`を減らして段階的に実行

### 復元方法
注意書きを削除したい場合：
1. 手動で記事を編集
2. 注意書き部分を削除
3. 保存

## 📞 サポート

### システム管理者への連絡事項
- 大量の古い記事が発見された場合
- エラーが継続する場合
- カスタマイズ要望がある場合

---

**最終更新**: 2025年1月30日  
**システム作成者**: 開発チーム