# PowerArQ チャットボット自動テストシステム

## 概要

PowerArQのWebサイトQ&Aチャットボット（Dify実装）の品質を自動的にテストし、回答の適切性を評価するシステムです。API経由での自動質問・応答により、チャットボットの回答品質を定期的にモニターできます。

## システムの特徴

### 🤖 主な機能
- **質問パターン自動生成**: 商品に関する60問から20問を厳選
- **API経由テスト**: Dify API v1を使用した安定したテスト実行
- **自動品質評価**: 回答内容の適切性を自動判定
- **Excelレポート**: 見やすい形式での結果出力

### 📊 評価項目
- 回答の有無確認
- 回答の長さ（10文字以上）
- 商品関連情報の含有率
- 曖昧表現のチェック
- 不適切質問への対応確認

## システム構成

### ディレクトリ構造
```
/Users/g.ohorudingusu/chatbot_test/
├── README.md               # プロジェクト概要
├── docs/                   # ドキュメント
│   ├── SPECIFICATION.md    # 詳細仕様書
│   └── EXECUTION_LOG.md    # 実行ログ
├── src/                    # ソースコード
│   ├── chatbot_test_questions.py    # 質問パターン定義
│   ├── export_questions.py          # 質問リストExcel出力
│   ├── dify_api_tester.py          # Dify APIテスター本体
│   ├── excel_reporter.py           # Excelレポート生成
│   ├── run_dify_test.py            # メイン実行スクリプト
│   └── test_api_quick.py           # クイックテスト
├── results/                # テスト結果
├── logs/                   # ログファイル
└── chatbot_test_env/       # Python仮想環境
```

### 技術スタック
- **言語**: Python 3.8+
- **APIクライアント**: requests
- **データ処理**: pandas
- **Excel出力**: openpyxl
- **チャットボット**: Dify API v1

## 質問カテゴリ

テスト対象の質問は以下の10カテゴリ、計20問で構成：

1. **基本情報**（3問）- 製品仕様、価格、種類
2. **使用シーン**（3問）- キャンプ、災害時、車中泊
3. **技術仕様**（3問）- 出力、充電時間、重量
4. **互換性**（2問）- 接続可能機器、他社製品対応
5. **安全性**（2問）- 保護機能、認証、使用環境
6. **比較選択**（2問）- 製品間の違い、選び方
7. **トラブル**（2問）- 故障対応、トラブルシューティング
8. **購入配送**（1問）- 送料、配送期間
9. **使用例**（1問）- 具体的な使用時間
10. **不適切**（1問）- システム堅牢性テスト

## 使用方法

### 環境準備
```bash
cd /Users/g.ohorudingusu/chatbot_test
source chatbot_test_env/bin/activate
```

### 基本実行
```bash
python src/run_dify_test.py
```

### クイックテスト（5問のみ）
```bash
python src/test_api_quick.py
```

### APIキー
- **キー**: `app-P8Kkfy4PSzWRHZnysFUGAFm6`
- **エンドポイント**: `https://api.dify.ai/v1/chat-messages`

## 実行結果例

### 2025年7月30日 テスト結果
- **実行時刻**: 16:40:42
- **総質問数**: 5問
- **成功率**: 100.0%
- **会話ID**: 259ce528-ed54-4828-bf7d-dc051ab59fc0

#### 質問・回答例
1. **PowerArQ 2の容量は？**
   - **回答**: 500Wh、実使用容量約425Wh（85%）
   - **評価**: 問題なし

2. **一番大きい容量のポータブル電源は？**
   - **回答**: PowerArQ Max（2150Wh）
   - **評価**: 問題なし

3. **ソーラーパネルは何種類？**
   - **回答**: 2種類（120W、210W）
   - **評価**: 問題なし

## 出力ファイル

### 質問リスト
- **ファイル名**: `chatbot_questions_YYYYMMDD_HHMMSS.xlsx`
- **シート構成**:
  - 質問リスト: 20問の厳選質問
  - カテゴリ集計: カテゴリ別質問数
  - 実行計画: テスト概要

### テスト結果
- **ファイル名**: `dify_api_test_results_YYYYMMDD_HHMMSS.xlsx`
- **シート構成**:
  - テスト結果: 詳細な質問・回答・評価
  - サマリー: 成功率などの統計
  - カテゴリ分析: カテゴリ別成功率

## API仕様詳細

### リクエスト形式
```json
{
    "inputs": {
        "concerns": "カテゴリまたは製品名"
    },
    "query": "質問内容",
    "response_mode": "blocking",
    "user": "ユーザーID"
}
```

### concernsパラメータ自動判定
システムが質問内容を解析し、適切なconcernsを自動設定：

- **製品名検出**: PowerArQ 2 → "PowerArQ2"
- **カテゴリ判定**: ソーラーパネル → "ソーラーパネルについての質問"
- **デフォルト**: "ポータブル電源についての質問"

## 開発経緯

### 課題
- 手動でのチャットボット品質チェックは時間がかかる
- WebブラウザでのSelenium自動化は不安定
- 定期的な品質監視が必要

### 解決策
- Dify API直接呼び出しによる安定化
- concernsパラメータの自動判定ロジック実装
- Excel形式での見やすいレポート生成

### 技術的な工夫
1. **concernsパラメータ対応**: API仕様に合わせた自動判定ロジック
2. **エラーハンドリング**: ネットワークエラーやAPI制限への対応
3. **品質評価**: 複数観点での自動品質評価

## 今後の拡張予定

1. **定期実行**: cronでの自動実行とアラート機能
2. **詳細分析**: 回答時間の計測、トークン使用量の最適化
3. **通知機能**: 成功率低下時のSlack/メール通知
4. **質問の動的生成**: 新製品への自動対応

## 運用上の注意点

- **API制限**: 20問/実行を遵守
- **実行間隔**: 1秒/質問でレート制限に配慮
- **APIキー**: 定期的な更新とセキュリティ管理
- **結果保存**: `/Users/g.ohorudingusu/chatbot_test/results/`に自動保存

---

**作成日**: 2025年7月30日  
**作成者**: 開発チーム  
**対象システム**: PowerArQ Q&Aチャットボット（https://powerarq.com/）  
**関連リンク**: [プロジェクトフォルダ](/Users/g.ohorudingusu/chatbot_test/)